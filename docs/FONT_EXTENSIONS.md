# JasperReports Font Extensions

## Automatic Font Extension Generation

The service automatically generates JasperReports font extension files when you register fonts. This ensures fonts work properly with JasperReports, especially for Khmer and other Unicode scripts.

## How It Works

When you register a font, the system automatically:

1. **Creates `fonts.xml`** - Defines font families with proper encoding
2. **Creates `jasperreports_extension.properties`** - Registers the fonts with JasperReports
3. **Updates on changes** - Regenerates when fonts are added or removed

## Generated Files

### fonts.xml
Located at: `src/main/resources/fonts.xml`

Example:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<fontFamilies>
    <fontFamily name="Khmer OS">
        <normal><![CDATA[/path/to/KhmerOS.ttf]]></normal>
        <bold><![CDATA[/path/to/KhmerOS-Bold.ttf]]></bold>
        <pdfEncoding>Identity-H</pdfEncoding>
        <pdfEmbedded>true</pdfEmbedded>
        <exportFonts/>
    </fontFamily>
</fontFamilies>
```

### jasperreports_extension.properties
Located at: `src/main/resources/jasperreports_extension.properties`

Example:
```properties
# JasperReports Font Extensions
# Auto-generated by JasperReports API Service

net.sf.jasperreports.extension.registry.factory.simple.font.families=net.sf.jasperreports.engine.fonts.SimpleFontExtensionsRegistryFactory
net.sf.jasperreports.extension.simple.font.families.custom=fonts.xml

# Enable headless mode for image generation
java.awt.headless=true
```

## API Endpoints

### View Font Extensions

```bash
GET /api/fonts/extensions
```

**Response:**
```json
{
  "hasExtensions": true,
  "fontsXml": "<?xml version=\"1.0\"...",
  "extensionProperties": "# JasperReports...",
  "registeredFontsCount": 3
}
```

**Example:**
```bash
curl http://localhost:8080/api/fonts/extensions | python3 -m json.tool
```

### Regenerate Font Extensions

```bash
POST /api/fonts/extensions/regenerate
```

**Response:**
```json
{
  "message": "Font extensions regenerated",
  "fontsCount": 3
}
```

**Example:**
```bash
curl -X POST http://localhost:8080/api/fonts/extensions/regenerate
```

## Usage Example

### 1. Register a Khmer Font

```bash
curl -X POST http://localhost:8080/api/fonts/register \
  -F "name=Khmer OS" \
  -F "normal=@KhmerOS.ttf"
```

### 2. Check Generated Extensions

```bash
curl http://localhost:8080/api/fonts/extensions
```

### 3. Use in Template

```xml
<textField>
    <reportElement x="0" y="0" width="555" height="30"/>
    <textElement>
        <font fontName="Khmer OS" size="18"/>
    </textElement>
    <textFieldExpression><![CDATA[$P{title}]]></textFieldExpression>
</textField>
```

### 4. Generate Report

```bash
curl -X POST "http://localhost:8080/api/reports/render/khmer-demo?format=PDF" \
  -H "Content-Type: application/json" \
  -d '{"title": "របាយការណ៍ប្រចាំខែ"}' \
  -o khmer-report.pdf
```

## Why This Matters for Khmer Fonts

Khmer script requires:
- **Identity-H encoding** - For proper Unicode character mapping
- **Font embedding** - To ensure characters display correctly
- **Proper font registration** - So JasperReports can find and use the fonts

The automatic extension generation ensures all these requirements are met.

## Multiple Fonts Example

Register multiple Khmer fonts:

```bash
# Register Khmer OS
curl -X POST http://localhost:8080/api/fonts/register \
  -F "name=Khmer OS" \
  -F "normal=@KhmerOS.ttf"

# Register Khmer OS Battambang
curl -X POST http://localhost:8080/api/fonts/register \
  -F "name=Khmer OS Battambang" \
  -F "normal=@KhmerOS_battambang.ttf"

# Register Khmer OS Content
curl -X POST http://localhost:8080/api/fonts/register \
  -F "name=Khmer OS Content" \
  -F "normal=@KhmerOS_content.ttf"
```

The generated `fonts.xml` will include all three:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<fontFamilies>
    <fontFamily name="Khmer OS">
        <normal><![CDATA[/path/to/KhmerOS.ttf]]></normal>
        <pdfEncoding>Identity-H</pdfEncoding>
        <pdfEmbedded>true</pdfEmbedded>
        <exportFonts/>
    </fontFamily>
    <fontFamily name="Khmer OS Battambang">
        <normal><![CDATA[/path/to/KhmerOS_battambang.ttf]]></normal>
        <pdfEncoding>Identity-H</pdfEncoding>
        <pdfEmbedded>true</pdfEmbedded>
        <exportFonts/>
    </fontFamily>
    <fontFamily name="Khmer OS Content">
        <normal><![CDATA[/path/to/KhmerOS_content.ttf]]></normal>
        <pdfEncoding>Identity-H</pdfEncoding>
        <pdfEmbedded>true</pdfEmbedded>
        <exportFonts/>
    </fontFamily>
</fontFamilies>
```

## Automatic Updates

The font extensions are automatically updated when you:

- ✅ **Register a new font** - Adds to fonts.xml
- ✅ **Remove a font** - Removes from fonts.xml
- ✅ **Clear all fonts** - Deletes extension files
- ✅ **Restart service** - Extensions persist and are loaded

## Manual Regeneration

If needed, you can manually regenerate the extensions:

```bash
curl -X POST http://localhost:8080/api/fonts/extensions/regenerate
```

This is useful if:
- You manually edited font files
- You want to refresh the configuration
- Something went wrong with automatic generation

## Troubleshooting

### Extensions not generated?

Check if fonts are registered:
```bash
curl http://localhost:8080/api/fonts
```

If fonts are registered but extensions missing:
```bash
curl -X POST http://localhost:8080/api/fonts/extensions/regenerate
```

### Fonts still not working?

1. **Verify font files exist:**
   ```bash
   curl http://localhost:8080/api/fonts | grep "normalPath"
   ```

2. **Check extensions were created:**
   ```bash
   ls -la src/main/resources/fonts.xml
   ls -la src/main/resources/jasperreports_extension.properties
   ```

3. **View extension content:**
   ```bash
   curl http://localhost:8080/api/fonts/extensions
   ```

4. **Restart the service:**
   ```bash
   ./gradlew run
   ```

## Benefits

✅ **Automatic** - No manual configuration needed
✅ **Dynamic** - Updates when fonts change
✅ **Proper encoding** - Identity-H for Unicode
✅ **Font embedding** - Ensures portability
✅ **Multiple fonts** - Supports unlimited fonts
✅ **Khmer support** - Optimized for Khmer script

## See Also

- [KHMER_FONTS_TROUBLESHOOTING.md](KHMER_FONTS_TROUBLESHOOTING.md) - Khmer font issues
- [FONT_REGISTRY.md](FONT_REGISTRY.md) - Font management API
- [USING_FONTS_IN_TEMPLATES.md](USING_FONTS_IN_TEMPLATES.md) - Template usage

---

**The font extensions are automatically managed - just register your fonts and they'll work!**
